<div class="container">
  <div class="table-container mat-elevation-z8" #container>
    <table mat-table [dataSource]="dataSource()" matSort aria-headerCellName="Data preview table"
      aria-label="Data preview table">

      <!-- Columna Nombre -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.NOMBRE">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.NOMBRE}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.NOMBRE)"
          [class.editable-cell]="isEditing(consumibleFormatDataBase.NOMBRE, i)"
          (click)="startEditing($event, row, consumibleFormatDataBase.NOMBRE, i)">
          @if (isEditing( consumibleFormatDataBase.NOMBRE, i)) {
          <custom-input [formControl]="getFormControl(i,consumibleFormatDataBase.NOMBRE)" maxCharacters="50"
            (touched)="finishEditing()" (enter)="finishEditing()" [showMessageError]="false">
          </custom-input>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.NOMBRE], consumibleFormatDataBase.NOMBRE) }}
          }
        </td>
      </ng-container>

      <!-- Columna Categoría -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.CATEGORIA">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.CATEGORIA}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.CATEGORIA)"
          (click)="startEditing($event, row, consumibleFormatDataBase.CATEGORIA, i)">
          @if (isEditing( consumibleFormatDataBase.CATEGORIA, i)) {
          <custom-input inputType="select" [formControl]="getFormControl(i,consumibleFormatDataBase.CATEGORIA)"
            [options]="selectOptions.categorias" valueProperty="id" displayProperty="name"
            (optionSelected)="finishEditing()" [showMessageError]="false">
          </custom-input>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.CATEGORIA], consumibleFormatDataBase.CATEGORIA) }}
          }
        </td>
      </ng-container>

      <!-- Columna Cantidad -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.CANTIDAD">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.CANTIDAD}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.CANTIDAD)"
          (click)="startEditing($event, row, consumibleFormatDataBase.CANTIDAD, i)">
          @if (isEditing( consumibleFormatDataBase.CANTIDAD, i)) {
          <input-number [formControl]="getFormControl(i,consumibleFormatDataBase.CANTIDAD)" (touched)="finishEditing()"
            (enter)="finishEditing()" [showMessageError]="false">
          </input-number>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.CANTIDAD], consumibleFormatDataBase.CANTIDAD) }}
          }
        </td>
      </ng-container>

      <!-- Columna Cantidad Mínima -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.CANTIDAD_MINIMA">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.CANTIDAD_MINIMA}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.CANTIDAD_MINIMA)"
          (click)="startEditing($event, row, consumibleFormatDataBase.CANTIDAD_MINIMA, i)">
          @if (isEditing( consumibleFormatDataBase.CANTIDAD_MINIMA, i)) {
          <input-number [formControl]="getFormControl(i,consumibleFormatDataBase.CANTIDAD_MINIMA)"
            (touched)="finishEditing()" (enter)="finishEditing()" [showMessageError]="false">
          </input-number>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.CANTIDAD_MINIMA], consumibleFormatDataBase.CANTIDAD_MINIMA) }}
          }
        </td>
      </ng-container>

      <!-- Columna Fabricante -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.FABRICANTE">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.FABRICANTE}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.FABRICANTE)"
          (click)="startEditing($event, row, consumibleFormatDataBase.FABRICANTE, i)">
          @if (isEditing( consumibleFormatDataBase.FABRICANTE, i)) {
          <custom-input inputType="select" [formControl]="getFormControl(i,consumibleFormatDataBase.FABRICANTE)"
            [options]="selectOptions.fabricantes" valueProperty="id" displayProperty="name"
            (optionSelected)="finishEditing()" [showMessageError]="false">
          </custom-input>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.FABRICANTE], consumibleFormatDataBase.FABRICANTE) }}
          }
        </td>
      </ng-container>

      <!-- Columna Modelo -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.MODELO">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.MODELO}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.MODELO)"
          (click)="startEditing($event, row, consumibleFormatDataBase.MODELO, i)">
          @if (isEditing( consumibleFormatDataBase.MODELO, i)) {
          <custom-input [formControl]="getFormControl(i,consumibleFormatDataBase.MODELO)" (touched)="finishEditing()"
            (enter)="finishEditing()" [showMessageError]="false" maxCharacters="30">
          </custom-input>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.MODELO], consumibleFormatDataBase.MODELO) }}
          }
        </td>
      </ng-container>

      <!-- Columna Proveedor -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.PROVEEDOR">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.PROVEEDOR}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.PROVEEDOR)"
          (click)="startEditing($event, row, consumibleFormatDataBase.PROVEEDOR, i)">
          @if (isEditing( consumibleFormatDataBase.PROVEEDOR, i)) {
          <custom-input inputType="select" [formControl]="getFormControl(i,consumibleFormatDataBase.PROVEEDOR)"
            [options]="selectOptions.proveedores" valueProperty="id" displayProperty="name"
            (optionSelected)="finishEditing()" [showMessageError]="false">
          </custom-input>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.PROVEEDOR], consumibleFormatDataBase.PROVEEDOR) }}
          }
        </td>
      </ng-container>

      <!-- Columna costo -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.COSTO">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.COSTO}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.COSTO)"
          (click)="startEditing($event, row, consumibleFormatDataBase.COSTO, i)">
          @if (isEditing(consumibleFormatDataBase.COSTO, i)) {
          <input-number [formControl]="getFormControl(i,consumibleFormatDataBase.COSTO)" (touched)="finishEditing()"
            (enter)="finishEditing()" [currency]="true" [showMessageError]="false">
          </input-number>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.COSTO], consumibleFormatDataBase.COSTO) }}
          }
        </td>
      </ng-container>

      <!-- Columna Número de Factura -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.NUMERO_DE_FACTURA">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.NUMERO_DE_FACTURA}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.NUMERO_DE_FACTURA)"
          (click)="startEditing($event, row, consumibleFormatDataBase.NUMERO_DE_FACTURA, i)">
          @if (isEditing( consumibleFormatDataBase.NUMERO_DE_FACTURA, i)) {
          <custom-input [formControl]="getFormControl(i,consumibleFormatDataBase.NUMERO_DE_FACTURA)"
            (touched)="finishEditing()" (enter)="finishEditing()" [showMessageError]="false" maxCharacters="50">
          </custom-input>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.NUMERO_DE_FACTURA],
          consumibleFormatDataBase.NUMERO_DE_FACTURA) }}
          }
        </td>
      </ng-container>

      <!-- Columna Fecha de Compra -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.FECHA_DE_COMPRA">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.FECHA_DE_COMPRA}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.FECHA_DE_COMPRA)"
          (click)="startEditing($event, row, consumibleFormatDataBase.FECHA_DE_COMPRA, i)">
          @if (isEditing( consumibleFormatDataBase.FECHA_DE_COMPRA, i)) {
          <input-date [formControl]="getFormControl(i,consumibleFormatDataBase.FECHA_DE_COMPRA)"
           (dateChange)="finishEditing()"
            [showMessageError]="false">
          </input-date>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.FECHA_DE_COMPRA], consumibleFormatDataBase.FECHA_DE_COMPRA) }}
          }
        </td>
      </ng-container>

      <!-- Columna Observaciones -->
      <ng-container [matColumnDef]="consumibleFormatDataBase.OBSERVACIONES">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{consumibleFormatExcelHeaders.OBSERVACIONES}}</th>
        <td mat-cell *matCellDef="let row; let i = index"
          [class.error-cell]="hasErrorInCell(row, consumibleFormatDataBase.OBSERVACIONES)"
          (click)="startEditing($event, row, consumibleFormatDataBase.OBSERVACIONES, i)">
          @if (isEditing(consumibleFormatDataBase.OBSERVACIONES, i)) {
          <custom-input inputType="textarea" [showMessageError]="false"
            [formControl]="getFormControl(i,consumibleFormatDataBase.OBSERVACIONES)" maxCharacters="200"
            (touched)="finishEditing()" (enter)="finishEditing()" rows="4">
          </custom-input>
          }@else {
          {{ formatCellValue(row[consumibleFormatDataBase.OBSERVACIONES], consumibleFormatDataBase.OBSERVACIONES) }}
          }
        </td>
      </ng-container>

      <!-- Filas de Cabecera y Datos -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" class="header-row"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.error-row]="hasErrorsInRow(row)"></tr>
    </table>
    <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-headerCellName="Seleccionar página"></mat-paginator>
  </div>

  <!-- Error Summary Section -->
  <mat-expansion-panel *ngIf="formInValid()" class="error-panel" expanded="true">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <span class="error-title"> Se encontraron errores en {{errorRowCount()}} filas</span>
      </mat-panel-title>
    </mat-expansion-panel-header>

    <div class="error-list">
      <mat-expansion-panel *ngFor="let rowError of errorsByRow()" class="row-error-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span class="row-error-title">
              Fila {{rowError.row + 1}} - {{rowError.errors.length}} {{ rowError.errors.length === 1 ? 'error' :
              'errores' }}
            </span>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="row-errors">
          <mat-card *ngFor="let error of rowError.errors" class="error-card">
            <mat-card-content>
              <div class="error-info">
                <span class="error-column">Columna: {{error.column}}</span>
                <span class="error-message">{{error.message}}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-expansion-panel>
    </div>
  </mat-expansion-panel>

  <!-- Submit Button -->
  <div class="submit-container">
    @if (!formInValid()) { <button mat-raised-button color="primary" (click)="onSubmit()">
      {{ 'Subir información' }}
    </button>
    } @else if(formInValid()) {
    <p>{{'Corrige los errores para continuar'}}</p>
    }
  </div>
</div>