<div class="container">
  <div class="table-container mat-elevation-z8" #container>
    <table mat-table [dataSource]="dataSource()" matSort aria-headerCellName="Data preview table"
      aria-label="Data preview table">
      <ng-container *ngFor="let column of displayedColumnsConfig" [matColumnDef]="column.dataCellName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ column.headerCellName }}</th>
        <td mat-cell *matCellDef="let row; let i = index" [class.error-cell]="hasErrorInCell(row, column.dataCellName)"
          [class.editable-cell]="isEditing(column.dataCellName, i)"
          (click)="startEditing($event,column.dataCellName, i)">
          @if (isEditing(column.dataCellName, i)) {

          @switch (column.dataCellName) {

          <!-- Columna Nombre -->
          @case (consumibleFormatDataBase.NOMBRE) {
          <custom-input [formControl]="getFormControl(i,consumibleFormatDataBase.NOMBRE)" maxCharacters="50"
            (touched)="finishEditing()" (enter)="finishEditing()" [showMessageError]="false">
          </custom-input>
          }
          <!-- Columna Categoría -->
          @case (consumibleFormatDataBase.CATEGORIA) {
          <custom-input inputType="select" [formControl]="getFormControl(i,consumibleFormatDataBase.CATEGORIA)"
            [options]="selectOptions.categorias" valueProperty="id" displayProperty="name"
            (optionSelected)="finishEditing()" [showMessageError]="false">
          </custom-input>

          <!-- Columna Cantidad -->
          }@case (consumibleFormatDataBase.CANTIDAD) {
          <input-number [formControl]="getFormControl(i,consumibleFormatDataBase.CANTIDAD)" (touched)="finishEditing()"
            (enter)="finishEditing()" [showMessageError]="false">
          </input-number>

          <!-- Columna Cantidad Mínima -->
          }@case (consumibleFormatDataBase.CANTIDAD_MINIMA) {
          <input-number [formControl]="getFormControl(i,consumibleFormatDataBase.CANTIDAD_MINIMA)"
            (touched)="finishEditing()" (enter)="finishEditing()" [showMessageError]="false">
          </input-number>

          <!-- Columna Fabricante -->
          }@case (consumibleFormatDataBase.FABRICANTE) {
          <custom-input inputType="select" [formControl]="getFormControl(i,consumibleFormatDataBase.FABRICANTE)"
            [options]="selectOptions.fabricantes" valueProperty="id" displayProperty="name"
            (optionSelected)="finishEditing()" [showMessageError]="false">
          </custom-input>

          <!-- Columna Modelo -->
          }@case (consumibleFormatDataBase.MODELO) {
          <custom-input [formControl]="getFormControl(i,consumibleFormatDataBase.MODELO)" (touched)="finishEditing()"
            (enter)="finishEditing()" [showMessageError]="false" maxCharacters="30">
          </custom-input>

          <!-- Columna Proveedor -->
          }@case (consumibleFormatDataBase.PROVEEDOR) {
          <custom-input inputType="select" [formControl]="getFormControl(i,consumibleFormatDataBase.PROVEEDOR)"
            [options]="selectOptions.proveedores" valueProperty="id" displayProperty="name"
            (optionSelected)="finishEditing()" [showMessageError]="false">
          </custom-input>

          <!-- Columna costo -->
          }@case (consumibleFormatDataBase.COSTO) {
          <input-number [formControl]="getFormControl(i,consumibleFormatDataBase.COSTO)" (touched)="finishEditing()"
            (enter)="finishEditing()" [currency]="true" [showMessageError]="false">
          </input-number>

          <!-- Columna Número de Factura -->
          }@case (consumibleFormatDataBase.NUMERO_DE_FACTURA) {
          <custom-input [formControl]="getFormControl(i,consumibleFormatDataBase.NUMERO_DE_FACTURA)"
            (touched)="finishEditing()" (enter)="finishEditing()" [showMessageError]="false" maxCharacters="50">
          </custom-input>

          <!-- Columna Fecha de Compra -->
          }@case (consumibleFormatDataBase.FECHA_DE_COMPRA) {
          <input-date [formControl]="getFormControl(i,consumibleFormatDataBase.FECHA_DE_COMPRA)"
            (dateChange)="finishEditing()" [showMessageError]="false">
          </input-date>

          <!-- Columna Observaciones -->
          }@case (consumibleFormatDataBase.OBSERVACIONES) {
          <custom-input inputType="textarea" [showMessageError]="false"
            [formControl]="getFormControl(i,consumibleFormatDataBase.OBSERVACIONES)" maxCharacters="200"
            (touched)="finishEditing()" (enter)="finishEditing()" rows="4">
          </custom-input>
          }
          }
          }@else {
          {{ formatCellValue(row[column.dataCellName], column.dataCellName) }}
          }
        </td>
      </ng-container>

      <!-- Filas de Cabecera y Datos -->
      <tr mat-header-row *matHeaderRowDef="getDisplayedColumns(); sticky: true" class="header-row"></tr>
      <tr mat-row *matRowDef="let row; columns: getDisplayedColumns();" [class.error-row]="hasErrorsInRow(row)"></tr>
    </table>
    <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-headerCellName="Seleccionar página"></mat-paginator>
  </div>

  <!-- Error Summary Section -->
  <mat-expansion-panel *ngIf="formInValid()" class="error-panel" expanded="true">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <span class="error-title"> Se encontraron errores en {{errorRowCount()}} filas</span>
      </mat-panel-title>
    </mat-expansion-panel-header>

    <div class="error-list">
      <mat-expansion-panel *ngFor="let rowError of errorsByRow()" class="row-error-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span class="row-error-title">
              Fila {{rowError.row + 1}} - {{rowError.errors.length}} {{ rowError.errors.length === 1 ? 'error' :
              'errores' }}
            </span>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="row-errors">
          <mat-card *ngFor="let error of rowError.errors" class="error-card">
            <mat-card-content>
              <div class="error-info">
                <span class="error-column">Columna: {{error.column}}</span>
                <span class="error-message">{{error.message}}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-expansion-panel>
    </div>
  </mat-expansion-panel>

  <!-- Submit Button -->
  <div class="submit-container">
    @if (!formInValid()) { <button mat-raised-button color="primary" (click)="onSubmit()">
      {{ 'Subir información' }}
    </button>
    } @else if(formInValid()) {
    <p>{{'Corrige los errores para continuar'}}</p>
    }
  </div>
</div>